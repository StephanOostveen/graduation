\section{State-of-the-art analysis}
\label{sec:sota}
As mentioned in Section~\ref{sec:problem_statement} due to the complexity of Time Sensitive Networking it is difficult to correctly estimate the network performance. Having an estimate for the performance is crucial in a projects design phase as the network influences the correct working of many real-time embedded systems. There exist three methods for quantifying a system's performance: measurements on a real system, mathematical analysis and simulation. Measurements are precise in determining a system's performance as you are measuring the real system with all its implementation details. But it is a difficult method for determining the relationship between variables and performance as experimentation can take a long time and measuring the inner workings of the system without affecting the system is hard. Finally, one first needs to build the system before measurements can be made, making it unsuitable for a design process. Mathematical analysis on the other hand can be performed without first building a system, gives clear and exact insights in the relationship between variables and performance. But analysis is difficult and reality must often be simplified to make it feasible. In certain cases the simplified system differs significantly from the real system, making it questionable whether the results fully apply to the real system. Lastly, simulation mixes the properties of measurements and analysis. It is still not an exact method for determining a system's performance as not all details will be modelled. But it can be a more detailed representation compared to the models used in analysis. Crucially it allows inspecting the inner workings of the subsystems without interfering with the result as is the case with measurements. Giving insight in the relationships between variables and performance. 

\todo{samenvatting}

\subsection{Benchmarks} Traditionally synthetic benchmarks are used in academia to evaluate the performance of proposed solutions as freely available descriptions of real-world automotive networks do not exist~\cite{ashjaei2021time}. One benchmark~\cite{kramer2015real} is available describing the characteristics of an internal combustion engine control application. Unfortunately this benchmark focuses on the real-time aspects of an application but does not describe the network architecture or traffic of that application. Furthermore, it is not clear how applicable the benchmark is to the system level of a vehicle. And lastly it is conceivable that an electric vehicle has different timing characteristics, different network architecture and data-flow than an internal combustion engine vehicle.

Part of a larger automotive network architecture has been described and used to compare various analysis methods and one simulation method in the context of worst-case response time analysis~\cite{kollman2010comparative}. The described architecture consists of nine ECUs connected to each other through a 500 kbit/second CAN bus, six ECUs connected to a 10 Mbit/second FlexRay bus and a gateway connecting the two busses together. The ECUs on the CAN bus transmit 85 different messages. A priority queue scheduling policy for the CAN driver is assumed while the paper acknowledges that many ECUs implement a FIFO policy which has detrimental effects on the worst-case response time. The software architecture of one CAN and one FlexRay ECU is described, containing the relevant scheduling algorithm, priorities, worst case execution times, periodicity and offsets. Important details not described are: size, source and destination of the CAN messages, the FlexRay schedule, and how the size of the described architecture compares to the real architecture. 

An anonymized system level description of a Volkswagen Golf 7 is used to show the relevance of system level simulation of automotive in-vehicle networks~\cite{meyer2019simulation}. A centralized gateway connects to 10 CAN busses containing a total of 42 ECUs sending 347 CAN messages periodically. A description of the ECUs internal software architecture such as RTOS, task scheduler, can message scheduling policy and task details is missing.

\subsection{Mathematical analysis}
\paragraph{Controller Area Network}
Real-time communication on CAN is possible, and a schedulability analysis exists~\cite{davis2007controller} for the case where a static set of CAN messages with fixed and unique priorities and message size. The messages have a fixed minimal inter-arrival time and are either strictly periodic or sporadic. The nodes in the network must ensure that when arbitration starts the highest priority queued frame at that node enters arbitration with the other nodes. This assumption is often violated by the hardware CAN peripheral inside the microcontrollers used in vehicles. For example, the Microchip Smartfusion m2s025 has several hardware buffers and the default algorithm for selecting which queued frame enters arbitration is round-robin. The work also provides an optimal priority assignment algorithm.

The effect of a first in first out scheduling policy in the CAN driver over a priority based policy is significant~\cite{davis2011controller}, the minimal bus speed such that the messages are schedulable doubled, with the maximum bus utilization decreasing by that same factor. The same paper presents a sufficient schedulability test for a system in which messages are scheduled both with a priority and first in first out policy. Finally, an optimal priority assignment algorithm for the mixed policy CAN bus is given.

\paragraph{Time Sensitive Networking}
An overview of the state-of-the-art research in Time Sensitive Networking (TSN) for automotive systems together with open challenges is presented in~\cite{ashjaei2021time}. It suggests the following TSN features to be implemented in new automotive networks: accurate and reliable clock synchronization (IEEE 802.1 AS) for a global, accurate and synchronized timebase, bounded latency for real-time traffic (IEEE 802.1Qav), reservation of resources for different traffic types (IEEE 802.1Qcc). To reduce jitter and achieve temporal isolation, which is necessary to achieve constructive composability as defined by~\cite{kopetz2003time}, scheduled traffic (IEEE 802.1Qbv) is needed. The work finally remarks that the Asynchronous Traffic Shaper (IEEE 802.1Qcr) is promising as it allows mixing real-time traffic types (periodic, sporadic and aperiodic) with integrated policing increasing robustness, but more research is necessary.

The Credit Based Shaper (CBS), IEEE 802.1Qav, was the first traffic shaper to be designed and standardized in 2009. As a result various schedulability analysis techniques have been developed. For example~\cite{de2014complete} uses Network Calculus to compute bounds on the worst case delay for the real time classes A and B. Computing bounds on the worst case end-to-end delay for sporadic flows sent using the classes A and B is possible using the method presented in~\cite{li2017deterministic}. Both lack the ability to calculate a worst cased delay on a specific message or periodic stream. A bound on the per frame delay can be calculated using the method presented in~\cite{cao2016independent}. 

An analysis method for computing a bound on the worst case end-to-end delay for frames from Time Aware Shaper (TAS) streams and non-TAS streams is presented in~\cite{thiele2015formal}. It assumes that all streams of a certain class have the same time interval in which they can be transmitted on a certain link. It also assumes the interval to be periodic. These assumptions are more restrictive than the TAS (IEEE 802.1Qbv) standard, which is not necessarily an issue for an automotive use-case as many applications produce and consume periodic data streams. The work in \cite{zhao2018timing} presents a schedulability analysis for CBS streams in a TAS network. Namely, the time slots for the TAS traffic, the guard bands and preemption overhead have effect on the QoS of CBS streams. The method proofs that the CBS credit does not overflow a certain threshold, concluding that the CBS streams are schedulable. A method for calculating the worst case delay a critical flow can experience at the output ports along the hops is presented in~\cite{zhao2018worst}. It allows gates of different queues to be opened at the same time and different flows are allowed to merge in the same queue. This method can be used to verify the real-time properties of a system, but can also be used in the optimization of the Gate Control Lists.

Regarding the preemption model introduced by IEEE 802.3br and IEEE 802.1Qbu some works~\cite{thiele2016formal},\cite{bello2020schedulability} have proposed analysis techniques, where the latter performed an evaluation of the technique compared to a simulation using the \omnet framework. But ~\cite{ashjaei2021time} mentions that more research is necessary to reduce pessimism in the schedulability analysis techniques of preemption together with TAS and CBS. Especially because~\cite{ashjaei2021novel} discovered a limitation in the frame preemption model presented in the TSN standard and used by the previously mentioned works. A new model is proposed~\cite{ashjaei2021novel} that is compatible with the TSN standards but reduces the bound on the maximum blocking delay compared to the original model. Through simulation using \omnet it is shown that the reduction is very significant when used in a multi-switch TSN network.

\subsection{Simulation}
Within the domain of network simulations, the discrete event simulation model is popular as it allows fast simulation of networks~\cite{ashjaei2021time}. Examples of existing discrete event simulation frameworks are \omnet, NS3 and the Matlab Simulink Discrete-Event simulation toolbox. \omnet is often used in academia to evaluate the effectiveness of analysis methods such as in~\cite{bello2020schedulability} and \cite{ashjaei2021novel}.

Because of the complexity of large TSN networks evaluating the performance of a network at design time is difficult. We have seen that analysis methods exist, but they can have limitations due to the assumptions they make on a network topology or configuration or because some underlying model does not fit the desired implementation, as seen in the analysis methods for preemption. Additionally, multiple parameters affect the performance of the network, such as maximum frame size, preemption model, network topology, TAS schedule, etc.~\cite{ashjaei2021time}. For these reasons and more, network simulation has been adopted in the industry and academia to evaluate performance of a design. Common network simulation frameworks such as \omnet and NS3 use a discrete event simulation model as it allows for fast simulation of networks~\cite{ashjaei2021time}. We have seen that \omnet is often used in academia to evaluate the effectiveness of analysis methods such as in~\cite{bello2020schedulability} and \cite{ashjaei2021novel}.

NeSTiNg~\cite{falk2019nesting} is based on the INET library~\cite{meszaros2019inet} that is an extension of \omnet. NeSTiNg adds models for the Credit Based Shaper, the Time Aware Shaper, frame preemption. It is lacking an implementation of the timing and clock synchronization standard (IEEE 802.1AS), timing is rather implemented using switch local clocks. Frame replication and elimination for redundancy (IEEE 802.1CB) is also not implemented by NeSTiNg. An extension was presented~\cite{houtan2021automated} which automates the generation of configuration files for the NeSTiNg framework and improves the use of the framework by adding graphical user interfaces for editing schedules, routing of flows etc.

A different \omnet framework supporting TSN is CoRE4INET~\cite{steinbach2011extension} which is based on the INET library as well. CoRE4INET provides models for TTEthernet, and parts of the AVB/TSN standards such as the CBS, TAS but is also lacking the timing and clock synchronization standard.

An \omnet simulation model for CAN and FlexRay is also available~\cite{meyer2019simulation}. An anonymized representation of a Volkswagen Golf 7 in-vehicle network is simulated and several metrics such as utilized bandwidth, latency, jitter and queue lengths are recorded. As an experiment a simulation is performed in which the CAN based gateway is replaced by a standard best-effort Ethernet switch and one CAN to Ethernet bridge for each CAN bus. In this experiment the CAN bus arbitration is still the largest source of end-to-end delay. The required bandwidth increases as the CAN messages are mapped as is to Ethernet frames and unicast is used instead of multicast when there are multiple destinations for a message.

Finally, it is worth mentioning that INET was recently updated (15 June 2022) adding support for key features of TSN. Notably support for a subset of the timing and synchronization standard (IEEE 802.1AS) is added. Individual network nodes can keep track of time, and modules implementing the time synchronization protocol have been added. Support for the CBS and TAS is also available as well as frame replication and elimination, and finally frame preemption support is also available.
